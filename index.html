<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ƒ∞≈ü Takip ve Analiz Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%); min-height: 100vh; padding: 20px; }
  .container { max-width: 1400px; margin: 0 auto; }
  .header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
  .header h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 2.5em;
      text-align: center;
  }
  h2, h3 { color: #333; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
  .stat-card { background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
  .stat-card.profit { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); }
  .stat-card.loss { background: linear-gradient(135deg, #f44336 0%, #da190b 100%); }
  .stat-card h3 { font-size: 2em; margin-bottom: 5px; }
  .stat-card p { opacity: 0.9; }
  .main-content { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
  .content-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
  .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
  .btn-primary { background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%); color: white; }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4); }
  .btn-success { background: #4caf50; color: white; }
  .btn-danger { background: #f44336; color: white; }
  .btn-secondary { background: #757575; color: white; }
  .btn-warning { background: #ff9800; color: white; }
  .btn-info { background: #2196f3; color: white; }
  .btn-sm { padding: 6px 12px; font-size: 14px; }
  .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .controls input, .controls select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
  .table-container { overflow-x: auto; }
  .jobs-table { width: 100%; border-collapse: collapse; }
  .jobs-table th { background: #f5f5f5; padding: 12px; text-align: left; color: #555; font-weight: 600; border-bottom: 2px solid #e0e0e0; }
  .jobs-table td { padding: 12px; border-bottom: 1px solid #e0e0e0; }
  .job-id-link { cursor: pointer; color: #B8860B; font-weight: bold; text-decoration: none; }
  .job-id-link:hover { text-decoration: underline; }
  .status-badge, .type-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; color: white; }
  .status-active { background: #4caf50; }
  .status-pending { background: #ff9800; }
  .status-completed { background: #2196f3; }
  .type-own { background: #9c27b0; }
  .type-subcontract { background: #ff5722; }
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
  .modal-content { background-color: white; margin: 2% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; }
  .modal-header { background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%); color: white; padding: 20px 30px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
  .close { color: white; font-size: 28px; font-weight: bold; cursor: pointer; background: none; border: none; }
  .modal-body { padding: 30px; }
  .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
  .tab-button { padding: 10px 20px; background: none; border: none; color: #666; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
  .tab-button.active { color: #B8860B; border-bottom-color: #B8860B; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
  .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
  .profit-positive { color: #4caf50 !important; }
  .profit-negative { color: #f44336 !important; }
  .action-buttons { display: flex; gap: 5px; }
  .customer-modal-layout { display: flex; gap: 20px; flex-wrap: wrap; }
  .customer-list { width: 100%; md:width: 30%; max-height: 60vh; overflow-y: auto; border-right: 1px solid #ddd; padding-right: 10px;}
  .customer-list div { padding: 10px; cursor: pointer; border-radius: 5px; }
  .customer-list div:hover, .customer-list div.active { background-color: #f0f0f0; }
  .customer-details { width: 100%; md:width: 70%; }
  .notification { position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; animation: slideIn 0.3s; }
  .notification.error { background: #f44336; }
  .chart-title-toggle { cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
  #chart-toggle-icon { transition: transform 0.3s ease; }
  .chart-title-toggle.open #chart-toggle-icon { transform: rotate(-180deg); }
  .collapsed { display: none; }
  @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @media print { body { padding: 0; background: none; } .header, .main-content .content-header, .controls, .jobs-table th:last-child, .jobs-table td:last-child, .modal, .notification { display: none !important; } .main-content { box-shadow: none; border-radius: 0; padding: 0; } .container { max-width: 100%; padding: 0; } .jobs-table { font-size: 10px; } .status-badge, .type-badge { color: #000 !important; background: #eee !important; border: 1px solid #ccc; } }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìä ƒ∞≈ü Takip ve Analiz Sistemi</h1>
        <div class="stats-grid">
            <div class="stat-card"><h3 id="totalJobs">0</h3><p>Toplam ƒ∞≈ü</p></div>
            <div class="stat-card"><h3 id="ownJobs">0</h3><p>Kendi ƒ∞≈ülerimiz</p></div>
            <div class="stat-card"><h3 id="subcontractJobs">0</h3><p>Ta≈üeron ƒ∞≈üler</p></div>
            <div class="stat-card"><h3 id="totalRevenue">‚Ç∫0</h3><p>Toplam Gelir</p></div>
            <div class="stat-card"><h3 id="totalCost">‚Ç∫0</h3><p>Toplam Maliyet</p></div>
            <div class="stat-card profit" id="profitCard"><h3 id="totalProfit">‚Ç∫0</h3><p>Net Kar</p></div>
        </div>
        <div class="chart-container" style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3 class="chart-title-toggle" onclick="toggleChartView()">
                üìà Aylƒ±k Analiz Grafiƒüi
                <span id="chart-toggle-icon">‚ñº</span>
            </h3>
            <div id="chartCanvasWrapper" class="collapsed">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
    <div class="main-content">
        <div class="content-header">
            <h2>üìÅ ƒ∞≈ü Dosyalarƒ±</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openNewJobModal()">+ Yeni ƒ∞≈ü Dosyasƒ±</button>
                <button class="btn btn-secondary" id="printAllBtn">üñ®Ô∏è Yazdƒ±r</button>
                <button class="btn btn-success" id="exportDataBtn">Dƒ±≈üa Aktar</button>
                <button class="btn btn-warning" id="importDataBtn">ƒ∞√ße Aktar</button>
                <button class="btn btn-info" onclick="openCustomerModal()">M√º≈üteriler</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" />
            </div>
        </div>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="M√º≈üteri veya ƒ∞≈ü No Ara..." onkeyup="filterJobs()" />
            <select id="filterStatus" onchange="filterJobs()"><option value="">T√ºm Durumlar</option><option value="Aktif">Aktif</option><option value="Beklemede">Beklemede</option><option value="Tamamlandƒ±">Tamamlandƒ±</option></select>
            <select id="filterType" onchange="filterJobs()"><option value="">T√ºm ƒ∞≈ü Tipleri</option><option value="own">Kendi ƒ∞≈üimiz</option><option value="subcontract">Ta≈üeron</option></select>
            <label>Tarih:</label>
            <input type="date" id="filterStartDate" onchange="filterJobs()" />
            <span>-</span>
            <input type="date" id="filterEndDate" onchange="filterJobs()" />
        </div>
        <div class="table-container">
            <table class="jobs-table">
                <thead><tr><th>ƒ∞≈ü No</th><th>M√º≈üteri</th><th>ƒ∞≈ü T√ºr√º</th><th>ƒ∞≈ü Tipi</th><th>Durum</th><th>Teklif</th><th>Maliyet</th><th>Kar</th><th>Tarih</th><th>ƒ∞≈ülemler</th></tr></thead>
                <tbody id="jobsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="jobModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modalTitle"></h2><button class="close" onclick="closeJobModal()">&times;</button></div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab(event, 'general')">üìã Genel</button>
                <button class="tab-button" onclick="switchTab(event, 'workType')">üîß Maliyet</button>
                <button class="tab-button" onclick="switchTab(event, 'service')">üìù Servis</button>
                <button class="tab-button" onclick="switchTab(event, 'analysis')">üìä Analiz</button>
            </div>
            
            <div id="general" class="tab-content active">
                <h3>Genel Bilgiler</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ƒ∞≈ü No</label><input type="text" id="jobNo" readonly /></div>
                    <div class="form-group"><label>M√º≈üteri Adƒ± *</label><input type="text" id="customerName" required /></div>
                    <div class="form-group"><label>Telefon</label><input type="tel" id="customerPhone" /></div>
                    <div class="form-group"><label>E-posta</label><input type="email" id="customerEmail" /></div>
                    <div class="form-group"><label>ƒ∞≈ü T√ºr√º *</label><select id="jobType" required><option value="Servis">Servis</option><option value="Bakƒ±m">Bakƒ±m</option><option value="Kurulum">Kurulum</option><option value="Arƒ±za">Arƒ±za</option><option value="Proje">Proje</option></select></div>
                    <div class="form-group"><label>Durum</label><select id="jobStatus"><option value="Aktif">Aktif</option><option value="Beklemede">Beklemede</option><option value="Tamamlandƒ±">Tamamlandƒ±</option></select></div>
                    <div class="form-group"><label>Ba≈ülangƒ±√ß Tarihi</label><input type="date" id="startDate" /></div>
                    <div class="form-group"><label>Biti≈ü Tarihi</label><input type="date" id="endDate" /></div>
                </div>
                <div class="form-group"><label>A√ßƒ±klama</label><textarea id="jobDescription" rows="4"></textarea></div>
            </div>
            <div id="workType" class="tab-content">
                <h3>ƒ∞≈ü Tipi ve Maliyet Bilgileri</h3>
                <div class="work-type-section" style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="work-type-options" style="display: flex; gap: 20px; margin-bottom: 20px;"><div class="work-type-option" style="display: flex; align-items: center; gap: 10px;"><input type="radio" id="ownWork" name="workType" value="own" checked onchange="toggleWorkType()" /><label for="ownWork">Kendi ƒ∞≈üimiz</label></div><div class="work-type-option" style="display: flex; align-items: center; gap: 10px;"><input type="radio" id="subcontractWork" name="workType" value="subcontract" onchange="toggleWorkType()" /><label for="subcontractWork">Ta≈üeron ƒ∞≈üi</label></div></div>
                    <div id="ownWorkFields"><div class="form-grid"><div class="form-group"><label>ƒ∞≈ü√ßilik Maliyeti (‚Ç∫)</label><input type="number" id="laborCost" min="0" step="0.01" onchange="calculateProfit()" /></div><div class="form-group"><label>Malzeme Maliyeti (‚Ç∫)</label><input type="number" id="materialCost" min="0" step="0.01" onchange="calculateProfit()" /></div><div class="form-group"><label>Diƒüer Giderler (‚Ç∫)</label><input type="number" id="otherCost" min="0" step="0.01" onchange="calculateProfit()" /></div><div class="form-group"><label>Toplam Maliyet (‚Ç∫)</label><input type="number" id="totalCostField" readonly /></div></div></div>
                    <div id="subcontractFields" style="display: none;"><div class="form-grid"><div class="form-group"><label>Ta≈üeron Firma</label><input type="text" id="subcontractorName" /></div><div class="form-group"><label>Ta≈üeron Fiyatƒ± (‚Ç∫)</label><input type="number" id="subcontractPrice" min="0" step="0.01" onchange="calculateProfit()" /></div><div class="form-group"><label>Ta≈üeron ƒ∞leti≈üim</label><input type="text" id="subcontractorContact" /></div></div></div>
                    <div class="form-grid"><div class="form-group"><label>M√º≈üteriye Verilen Teklif (‚Ç∫) *</label><input type="number" id="quotedPrice" min="0" step="0.01" required onchange="calculateProfit()" /></div><div class="form-group"><label>KDV (%)</label><input type="number" id="tax" min="0" max="100" value="18" onchange="calculateProfit()" /></div><div class="form-group"><label>KDV Dahil Toplam (‚Ç∫)</label><input type="number" id="totalWithTax" readonly /></div><div class="form-group"><label>Kar/Zarar (‚Ç∫)</label><input type="number" id="profitField" readonly /></div></div>
                </div>
            </div>

            <div id="service" class="tab-content">
                <h3>Servis Detaylarƒ±</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Cihaz/√úr√ºn</label><input type="text" id="deviceName" /></div>
                    <div class="form-group"><label>Marka</label><input type="text" id="deviceBrand" /></div>
                    <div class="form-group"><label>Model</label><input type="text" id="deviceModel" /></div>
                    <div class="form-group"><label>Seri No</label><input type="text" id="serialNo" /></div>
                </div>
                <div class="form-group"><label>Arƒ±za/Problem</label><textarea id="problemDescription" rows="3"></textarea></div>
                <div class="form-group"><label>Yapƒ±lan ƒ∞≈ülemler</label><textarea id="workDone" rows="3"></textarea></div>
                <div class="form-group"><label>Kullanƒ±lan Par√ßalar</label><textarea id="partsUsed" rows="3"></textarea></div>
                <div class="form-group"><label>ƒ∞li≈ükili Dosya Linkleri (Her satƒ±ra bir tane)</label><textarea id="fileLinks" rows="3" placeholder="https://ornek.com/dosya.pdf"></textarea></div>
            </div>

            <div id="analysis" class="tab-content">
                <h3>Kar/Zarar Analizi</h3>
                <div class="analysis-card" style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <div class="analysis-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div class="analysis-item" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #DAA520;"><h4>Teklif Fiyatƒ±</h4><p id="analysisQuote">‚Ç∫0</p></div>
                        <div class="analysis-item" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #DAA520;"><h4>Toplam Maliyet</h4><p id="analysisCost">‚Ç∫0</p></div>
                        <div class="analysis-item" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #DAA520;"><h4>Net Kar/Zarar</h4><p id="analysisProfit" class="profit-positive">‚Ç∫0</p></div>
                        <div class="analysis-item" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #DAA520;"><h4>Kar Marjƒ±</h4><p id="analysisProfitMargin">%0</p></div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                <button class="btn btn-success" onclick="saveJob()">Kaydet</button>
                <button class="btn btn-danger" id="deleteBtn" onclick="deleteCurrentJob()">Sil</button>
                <button class="btn btn-secondary" onclick="closeJobModal()">ƒ∞ptal</button>
            </div>
        </div>
    </div>
</div>

<div id="customerModal" class="modal">
    <div class="modal-content"><div class="modal-header"><h2>M√º≈üteri Y√∂netimi</h2><button class="close" onclick="document.getElementById('customerModal').style.display='none'">&times;</button></div>
        <div class="modal-body"><div class="customer-modal-layout">
            <div class="customer-list" id="customerList"></div>
            <div class="customer-details" id="customerDetails"><h3>M√º≈üteri ƒ∞≈ü Ge√ßmi≈üi</h3><div id="customerJobHistory">L√ºtfen bir m√º≈üteri se√ßin.</div></div>
        </div></div>
    </div>
</div>


<script>
    let jobs = [];
    let currentJobId = null;
    let jobCounter = 1;
    let monthlyChartInstance = null;

    // --- YARDIMCI FONKSƒ∞YONLAR ---
    function formatNumber(value) {
        const number = parseFloat(value) || 0;
        return number.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function toggleChartView() {
        const chartWrapper = document.getElementById('chartCanvasWrapper');
        const chartTitle = document.querySelector('.chart-title-toggle');
        chartWrapper.classList.toggle('collapsed');
        chartTitle.classList.toggle('open');
    }

    function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = "notification " + (type === "error" ? "error" : "");
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
    }
    
    function refreshAllData() {
        updateStatistics();
        renderJobsTable();
        renderChart();
    }

    function resetForm() {
        document.querySelectorAll("#jobModal input, #jobModal textarea, #jobModal select").forEach((el) => {
            if (el.type === "radio") {
                if (el.id === "ownWork") el.checked = true;
            } else if (el.type !== "button" && el.id !== "jobNo") {
                el.value = "";
            }
        });
        document.getElementById("jobType").value = "Servis";
        document.getElementById("jobStatus").value = "Aktif";
        document.getElementById("tax").value = "18";
        toggleWorkType();
        switchTab(null, 'general');
    }

    function switchTab(event, tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.remove("active"));
        document.querySelectorAll(".tab-button").forEach((btn) => btn.classList.remove("active"));
        
        const tabEl = document.getElementById(tabName);
        if (tabEl) tabEl.classList.add("active");
        
        const tabButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
        if (tabButton) tabButton.classList.add('active');

        if (tabName === "analysis") calculateProfit();
    }

    // --- ANA VERƒ∞ ƒ∞≈ûLEMLERƒ∞ ---
    function saveJobsToStorage() {
        localStorage.setItem("businessJobs", JSON.stringify(jobs));
        localStorage.setItem("jobCounter", jobCounter.toString());
    }

    function loadJobsFromStorage() {
        const savedJobs = localStorage.getItem("businessJobs");
        const savedCounter = localStorage.getItem("jobCounter");
        if (savedJobs) jobs = JSON.parse(savedJobs);
        if (savedCounter) jobCounter = parseInt(savedCounter);
    }
    
    // --- GRAFƒ∞K ---
    function renderChart() {
        const completedJobs = jobs.filter(j => j.status === 'Tamamlandƒ±' && (j.endDate || j.startDate));
        const monthlyData = completedJobs.reduce((acc, job) => {
            const date = job.endDate || job.startDate;
            if (!date) return acc;
            const month = date.substring(0, 7); // YYYY-MM formatƒ±
            if (!acc[month]) acc[month] = { revenue: 0, profit: 0 };
            acc[month].revenue += job.quotedPrice || 0;
            acc[month].profit += job.profit || 0;
            return acc;
        }, {});

        const timeline = [];
        let currentDate = new Date('2025-08-01');
        for (let i = 0; i < 12; i++) {
            const monthKey = currentDate.toISOString().substring(0, 7);
            const monthLabel = currentDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
            timeline.push({ key: monthKey, label: monthLabel });
            currentDate.setMonth(currentDate.getMonth() + 1);
        }

        const labels = timeline.map(t => t.label);
        const revenueData = timeline.map(t => monthlyData[t.key]?.revenue || 0);
        const profitData = timeline.map(t => monthlyData[t.key]?.profit || 0);

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        if (monthlyChartInstance) monthlyChartInstance.destroy();

        monthlyChartInstance = new Chart(ctx, {
            type: 'bar', // GRAFƒ∞K Tƒ∞Pƒ∞ DEƒûƒ∞≈ûTƒ∞Rƒ∞LDƒ∞
            data: {
                labels: labels,
                datasets: [
                    { label: 'Toplam Gelir (‚Ç∫)', data: revenueData, backgroundColor: '#DAA520' },
                    { label: 'Net Kar (‚Ç∫)', data: profitData, backgroundColor: '#4caf50' }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: '12 Aylƒ±k Gelir ve Kar Analizi (Tamamlanan ƒ∞≈üler)', font: { size: 16 } },
                    tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ‚Ç∫${formatNumber(ctx.parsed.y)}` } }
                },
                scales: { 
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, ticks: { callback: value => `‚Ç∫${formatNumber(value)}` } } 
                }
            }
        });
    }


    // --- DI≈ûA/ƒ∞√áE AKTARMA ---
    function exportData() {
        if (jobs.length === 0) return showNotification("Dƒ±≈üa aktarƒ±lacak veri yok.", "error");
        const dataToExport = JSON.stringify({ jobs, jobCounter }, null, 2);
        const blob = new Blob([dataToExport], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `is_takip_yedek_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification("Veriler ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±.");
    }

    function importData() {
        const fileInput = document.getElementById('importFileInput');
        fileInput.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.jobs && data.jobCounter) {
                        if (confirm("Mevcut t√ºm veriler silinecek ve bu yedek y√ºklenecektir. Emin misiniz?")) {
                            jobs = data.jobs;
                            jobCounter = data.jobCounter;
                            saveJobsToStorage();
                            refreshAllData();
                            showNotification("Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±.");
                        }
                    } else { throw new Error("Ge√ßersiz dosya formatƒ±."); }
                } catch (error) { showNotification("Veri i√ße aktarƒ±lƒ±rken hata olu≈ütu: " + error.message, "error"); }
            };
            reader.readAsText(file);
        };
        fileInput.value = '';
        fileInput.click();
    }

    // --- M√ú≈ûTERƒ∞ Y√ñNETƒ∞Mƒ∞ ---
    function openCustomerModal() {
        const customerListEl = document.getElementById('customerList');
        const customerDetailsEl = document.getElementById('customerDetails');
        customerListEl.innerHTML = '';
        customerDetailsEl.innerHTML = '<h3>M√º≈üteri ƒ∞≈ü Ge√ßmi≈üi</h3><div>L√ºtfen bir m√º≈üteri se√ßin.</div>';
        const customers = [...new Set(jobs.map(job => job.customerName.trim()).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'tr'));
        
        if (customers.length === 0) {
            customerListEl.innerHTML = 'M√º≈üteri bulunmuyor.';
        } else {
            customers.forEach(customerName => {
                const div = document.createElement('div');
                div.textContent = customerName;
                div.onclick = (e) => {
                    Array.from(customerListEl.children).forEach(child => child.classList.remove('active'));
                    e.target.classList.add('active');
                    showCustomerHistory(customerName);
                };
                customerListEl.appendChild(div);
            });
        }
        document.getElementById('customerModal').style.display = 'block';
    }

    function showCustomerHistory(customerName) {
        const customerJobs = jobs.filter(job => job.customerName === customerName).sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
        const detailsEl = document.getElementById('customerDetails');
        let totalBilled = 0;
        let html = `<h3>${customerName} - ƒ∞≈ü Ge√ßmi≈üi (${customerJobs.length} i≈ü)</h3>`;

        if (customerJobs.length > 0) {
            html += `<div class="table-container"><table class="jobs-table" style="font-size: 12px;"><thead><tr><th>ƒ∞≈ü No</th><th>Tarih</th><th>Durum</th><th>Teklif</th></tr></thead><tbody>`;
            customerJobs.forEach(job => {
                html += `<tr>
                    <td><a href="#" class="job-id-link" onclick="document.getElementById('customerModal').style.display='none'; editJob('${job.id}')">${job.id}</a></td>
                    <td>${job.startDate || '-'}</td>
                    <td><span class="status-badge ${getStatusClass(job.status)}">${job.status}</span></td>
                    <td>‚Ç∫${formatNumber(job.quotedPrice)}</td>
                </tr>`;
                totalBilled += job.quotedPrice || 0;
            });
            html += `</tbody></table></div>`;
            html += `<h4 style="margin-top: 20px;">Toplam Teklif Tutarƒ±: ‚Ç∫${formatNumber(totalBilled)}</h4>`;
        } else {
            html += '<p>Bu m√º≈üteriye ait i≈ü bulunmuyor.</p>';
        }
        detailsEl.innerHTML = html;
    }
    
    // --- ANA SAYFA G√ñR√úN√úM√ú ---
    function updateStatistics() {
        const totalJobs = jobs.length;
        const ownJobs = jobs.filter(j => j.workType === "own").length;
        const subcontractJobs = jobs.length - ownJobs;
        const completedJobs = jobs.filter(j => j.status === "Tamamlandƒ±");
        const totalRevenue = completedJobs.reduce((sum, j) => sum + (j.quotedPrice || 0), 0);
        const totalCost = completedJobs.reduce((sum, j) => sum + (j.totalCost || 0), 0);
        const totalProfit = totalRevenue - totalCost;

        document.getElementById("totalJobs").textContent = totalJobs;
        document.getElementById("ownJobs").textContent = ownJobs;
        document.getElementById("subcontractJobs").textContent = subcontractJobs;
        document.getElementById("totalRevenue").textContent = "‚Ç∫" + formatNumber(totalRevenue);
        document.getElementById("totalCost").textContent = "‚Ç∫" + formatNumber(totalCost);
        document.getElementById("totalProfit").textContent = "‚Ç∫" + formatNumber(totalProfit);

        const profitCard = document.getElementById("profitCard");
        profitCard.classList.toggle("loss", totalProfit < 0);
        profitCard.classList.toggle("profit", totalProfit >= 0);
    }
    
    // --- Fƒ∞LTRELEME VE TABLO √áƒ∞Zƒ∞Mƒ∞ ---
    function filterJobs() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const statusFilter = document.getElementById("filterStatus").value;
        const typeFilter = document.getElementById("filterType").value;
        const startDateFilter = document.getElementById("filterStartDate").value;
        const endDateFilter = document.getElementById("filterEndDate").value;
        
        let filteredJobs = jobs.filter(job => {
            const jobDateStr = job.startDate;
            if (startDateFilter && (!jobDateStr || jobDateStr < startDateFilter)) return false;
            if (endDateFilter && (!jobDateStr || jobDateStr > endDateFilter)) return false;
            if (statusFilter && job.status !== statusFilter) return false;
            if (typeFilter && job.workType !== typeFilter) return false;
            if (searchTerm && !(job.customerName.toLowerCase().includes(searchTerm) || job.id.toLowerCase().includes(searchTerm))) return false;
            return true;
        });
        renderFilteredJobs(filteredJobs);
    }

    function renderFilteredJobs(filteredJobs) {
        const tbody = document.getElementById("jobsTableBody");
        if (filteredJobs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Filtreye uygun sonu√ß bulunamadƒ±</td></tr>';
            return;
        }
        tbody.innerHTML = filteredJobs.map(job => getJobRowHtml(job)).join('');
    }
    
    function renderJobsTable() {
        renderFilteredJobs(jobs);
    }

    function getJobRowHtml(job) {
        const profitClass = (job.profit || 0) >= 0 ? "profit-positive" : "profit-negative";
        return `
            <tr>
                <td><a href="#" class="job-id-link" onclick="event.preventDefault(); editJob('${job.id}')">${job.id}</a></td>
                <td>${job.customerName}</td>
                <td>${job.jobType}</td>
                <td><span class="type-badge ${job.workType === "own" ? "type-own" : "type-subcontract"}">${job.workType === "own" ? "Kendi" : "Ta≈üeron"}</span></td>
                <td><span class="status-badge ${getStatusClass(job.status)}">${job.status}</span></td>
                <td>‚Ç∫${formatNumber(job.quotedPrice)}</td>
                <td>‚Ç∫${formatNumber(job.totalCost)}</td>
                <td class="${profitClass}">‚Ç∫${formatNumber(job.profit)}</td>
                <td>${job.startDate || "-"}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editJob('${job.id}')">D√ºzenle</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete('${job.id}')">Sil</button>
                        <button class="btn btn-secondary btn-sm" onclick="printSingleJob('${job.id}')">üñ®Ô∏è Yazdƒ±r</button>
                    </div>
                </td>
            </tr>`;
    }

    function getStatusClass(status) {
        const classes = { "Aktif": "status-active", "Beklemede": "status-pending", "Tamamlandƒ±": "status-completed" };
        return classes[status] || "";
    }

    // --- MODAL FONKSƒ∞YONLARI ---
    function openNewJobModal() {
        currentJobId = null;
        document.getElementById("modalTitle").textContent = "Yeni ƒ∞≈ü Dosyasƒ±";
        document.getElementById('jobModal').style.display = 'block';
        resetForm();
        document.getElementById("deleteBtn").style.display = "none";
        document.getElementById("jobNo").value = "JOB" + String(jobCounter).padStart(4, "0");
        document.getElementById("startDate").value = new Date().toISOString().split("T")[0];
    }

    function editJob(jobId) {
        const job = jobs.find(j => j.id === jobId);
        if (!job) return;
        currentJobId = jobId;
        document.getElementById("modalTitle").textContent = "ƒ∞≈ü Dosyasƒ± D√ºzenle";
        resetForm();
        document.getElementById("deleteBtn").style.display = "inline-block";
        
        Object.keys(job).forEach(key => {
            const el = document.getElementById(key);
            if (el && typeof job[key] !== 'undefined') el.value = job[key];
        });
        
        if (job.workType === "subcontract") {
            document.getElementById("subcontractWork").checked = true;
        } else {
            document.getElementById("ownWork").checked = true;
        }

        toggleWorkType();
        calculateProfit();
        document.getElementById('jobModal').style.display = 'block';
    }
    
    function closeJobModal() {
        document.getElementById('jobModal').style.display = 'none';
        currentJobId = null;
    }

    function toggleWorkType() {
        const isOwn = document.getElementById("ownWork").checked;
        document.getElementById("ownWorkFields").style.display = isOwn ? "block" : "none";
        document.getElementById("subcontractFields").style.display = isOwn ? "none" : "block";
        calculateProfit();
    }

    function calculateProfit() {
        let cost = 0;
        const isOwn = document.getElementById("ownWork").checked;
        if (isOwn) {
            cost = (parseFloat(document.getElementById("laborCost").value) || 0) +
                   (parseFloat(document.getElementById("materialCost").value) || 0) +
                   (parseFloat(document.getElementById("otherCost").value) || 0);
            document.getElementById("totalCostField").value = cost.toFixed(2);
        } else {
            cost = parseFloat(document.getElementById("subcontractPrice").value) || 0;
        }

        const quoted = parseFloat(document.getElementById("quotedPrice").value) || 0;
        const tax = parseFloat(document.getElementById("tax").value) || 0;
        const totalWithTax = quoted + (quoted * tax) / 100;
        const profit = quoted - cost;
        const profitMargin = quoted > 0 ? (profit / quoted) * 100 : 0;

        document.getElementById("totalWithTax").value = totalWithTax.toFixed(2);
        document.getElementById("profitField").value = profit.toFixed(2);
        
        document.getElementById("analysisQuote").textContent = "‚Ç∫" + formatNumber(quoted);
        document.getElementById("analysisCost").textContent = "‚Ç∫" + formatNumber(cost);
        const profitEl = document.getElementById("analysisProfit");
        profitEl.textContent = "‚Ç∫" + formatNumber(profit);
        profitEl.className = profit >= 0 ? "profit-positive" : "profit-negative";
        document.getElementById("analysisProfitMargin").textContent = "%" + profitMargin.toFixed(1);
    }
    
    function saveJob() {
        const customerName = document.getElementById("customerName").value;
        const quotedPrice = document.getElementById("quotedPrice").value;

        if (!customerName || !quotedPrice) {
            return showNotification("L√ºtfen zorunlu alanlarƒ± doldurun!", "error");
        }

        const isOwn = document.getElementById("ownWork").checked;
        let cost = 0;
        if (isOwn) {
            cost = (parseFloat(document.getElementById("laborCost").value) || 0) +
                   (parseFloat(document.getElementById("materialCost").value) || 0) +
                   (parseFloat(document.getElementById("otherCost").value) || 0);
        } else {
            cost = parseFloat(document.getElementById("subcontractPrice").value) || 0;
        }

        const jobData = {
            id: document.getElementById("jobNo").value, customerName,
            customerPhone: document.getElementById("customerPhone").value,
            customerEmail: document.getElementById("customerEmail").value,
            jobType: document.getElementById("jobType").value,
            status: document.getElementById("jobStatus").value,
            startDate: document.getElementById("startDate").value,
            endDate: document.getElementById("endDate").value,
            description: document.getElementById("jobDescription").value,
            workType: isOwn ? "own" : "subcontract",
            laborCost: isOwn ? parseFloat(document.getElementById("laborCost").value) || 0 : 0,
            materialCost: isOwn ? parseFloat(document.getElementById("materialCost").value) || 0 : 0,
            otherCost: isOwn ? parseFloat(document.getElementById("otherCost").value) || 0 : 0,
            subcontractorName: !isOwn ? document.getElementById("subcontractorName").value : "",
            subcontractPrice: !isOwn ? parseFloat(document.getElementById("subcontractPrice").value) || 0 : 0,
            subcontractorContact: !isOwn ? document.getElementById("subcontractorContact").value : "",
            quotedPrice: parseFloat(quotedPrice),
            tax: parseFloat(document.getElementById("tax").value) || 18,
            totalCost: cost,
            profit: parseFloat(quotedPrice) - cost,
            deviceName: document.getElementById("deviceName").value,
            deviceBrand: document.getElementById("deviceBrand").value,
            deviceModel: document.getElementById("deviceModel").value,
            serialNo: document.getElementById("serialNo").value,
            problemDescription: document.getElementById("problemDescription").value,
            workDone: document.getElementById("workDone").value,
            partsUsed: document.getElementById("partsUsed").value,
            fileLinks: document.getElementById("fileLinks").value,
            createdAt: currentJobId ? jobs.find(j=>j.id === currentJobId).createdAt : new Date().toISOString(),
        };

        if (currentJobId) {
            const index = jobs.findIndex(j => j.id === currentJobId);
            if (index !== -1) jobs[index] = jobData;
        } else {
            jobs.push(jobData);
            jobCounter++;
        }
        saveJobsToStorage();
        refreshAllData();
        closeJobModal();
        showNotification("ƒ∞≈ü dosyasƒ± ba≈üarƒ±yla kaydedildi!");
    }
    
    function deleteCurrentJob() {
        if (currentJobId) confirmDelete(currentJobId);
    }
    
    function confirmDelete(jobId) {
        if (confirm("Bu i≈ü dosyasƒ±nƒ± silmek istediƒüinizden emin misiniz?")) {
            jobs = jobs.filter(j => j.id !== jobId);
            saveJobsToStorage();
            refreshAllData();
            if (document.getElementById('jobModal').style.display === 'block') {
                closeJobModal();
            }
            showNotification("ƒ∞≈ü dosyasƒ± silindi!");
        }
    }

    function printSingleJob(jobId) {
        const job = jobs.find(j => j.id === jobId);
        if (!job) return;
        const printWindow = window.open('', '_blank', 'height=600,width=800');
        let financialDetails = '';
        if (job.workType === 'own') {
            financialDetails = `<tr><td>ƒ∞≈ü√ßilik Maliyeti:</td><td>‚Ç∫${formatNumber(job.laborCost)}</td></tr><tr><td>Malzeme Maliyeti:</td><td>‚Ç∫${formatNumber(job.materialCost)}</td></tr><tr><td>Diƒüer Giderler:</td><td>‚Ç∫${formatNumber(job.otherCost)}</td></tr>`;
        } else {
            financialDetails = `<tr><td>Ta≈üeron Firma:</td><td>${job.subcontractorName || '-'}</td></tr><tr><td>Ta≈üeron Fiyatƒ±:</td><td>‚Ç∫${formatNumber(job.subcontractPrice)}</td></tr>`;
        }
        const content = `<html><head><title>ƒ∞≈ü Raporu - ${job.id}</title><style>body{font-family:sans-serif;margin:20px}h1,h2{color:#333;border-bottom:2px solid #eee;padding-bottom:5px}table{width:100%;border-collapse:collapse;margin-bottom:20px}td{padding:8px;border:1px solid #ddd}td:first-child{font-weight:bold;background-color:#f9f9f9;width:200px}p,pre{white-space:pre-wrap;background:#f5f5f5;padding:10px;border-radius:5px;font-family:inherit}</style></head><body><h1>ƒ∞≈ü Raporu - ${job.id}</h1><h2>Genel Bilgiler</h2><table><tr><td>M√º≈üteri:</td><td>${job.customerName}</td></tr><tr><td>Telefon:</td><td>${job.customerPhone||'-'}</td></tr><tr><td>ƒ∞≈ü T√ºr√º:</td><td>${job.jobType}</td></tr><tr><td>Durum:</td><td>${job.status}</td></tr><tr><td>Ba≈ülangƒ±√ß Tarihi:</td><td>${job.startDate||'-'}</td></tr></table><h2>Mali Bilgiler</h2><table><tr><td>Teklif Fiyatƒ±:</td><td>‚Ç∫${formatNumber(job.quotedPrice)}</td></tr>${financialDetails}<tr><td>Toplam Maliyet:</td><td>‚Ç∫${formatNumber(job.totalCost)}</td></tr><tr><td>Net Kar/Zarar:</td><td>‚Ç∫${formatNumber(job.profit)}</td></tr></table><h2>Servis Detaylarƒ±</h2><h3>Arƒ±za/Problem</h3><p>${job.problemDescription||'-'}</p><h3>Yapƒ±lan ƒ∞≈ülemler</h3><p>${job.workDone||'-'}</p><h3>Kullanƒ±lan Par√ßalar</h3><p>${job.partsUsed||'-'}</p><h3>Dosya Linkleri</h3><pre>${job.fileLinks || '-'}</pre></body></html>`;
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
    }
    
    // --- OLAY Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
    document.addEventListener("DOMContentLoaded", function () {
        loadJobsFromStorage();
        refreshAllData();
        
        document.getElementById("printAllBtn").addEventListener("click", () => window.print());
        document.getElementById("exportDataBtn").addEventListener("click", exportData);
        document.getElementById("importDataBtn").addEventListener("click", importData);
    });
</script>

</body>
</html>